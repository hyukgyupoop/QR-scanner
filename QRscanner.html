<!DOCTYPE html>
<html>
<head>
    <title>QR ì½”ë“œ ì‹¤ì‹œê°„ ê²€ì¦ê¸°</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; text-align: center; margin: 0; padding: 0; background-color: #f0f0f0; }
        h2 { margin-top: 20px; }
        #reader { width: 100%; max-width: 500px; margin: 20px auto; background: #000; }
        #result-display { 
            padding: 20px; 
            margin: 10px;
            color: white; 
            font-size: 1.1em; 
            font-weight: bold; 
            min-height: 50px; 
            border-radius: 8px;
            word-break: break-all; /* ê¸´ ì—ëŸ¬ ë©”ì‹œì§€ ì¤„ë°”ê¿ˆ */
        }
        .valid { background-color: #4CAF50; } /* ë…¹ìƒ‰ */
        .invalid { background-color: #F44336; } /* ë¹¨ê°„ìƒ‰ */
        .warning { background-color: #FF9800; } /* ì£¼í™©ìƒ‰ */
    </style>
</head>
<body>

    <h2>ì¿ í° ì½”ë“œ ìŠ¤ìºë„ˆ</h2>
    <p>QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ ì¤‘ì•™ì— ë§ì¶°ì£¼ì„¸ìš”.</p>

    <div id="reader"></div>

    <div id="result-display" class="warning">
        ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...
    </div>

    <script>
        // ğŸš¨ [ì¤‘ìš”] ì—¬ê¸°ì— Apps Script ë°°í¬ URLì„ ì •í™•íˆ ë„£ì–´ì£¼ì„¸ìš”!
        // ë”°ì˜´í‘œ("") ì•ˆì— ì£¼ì†Œë¥¼ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.
        const API_URL = "https://script.google.com/macros/s/AKfycbwhuc8G0ZLnjIoxxnwTD4Ei7neveg0263nVRI5ztiFZb9gQnVPvp_9f1shLWdvQ-mnD/exec"; 

        const html5QrCode = new Html5Qrcode("reader");

        // ìŠ¤ìº” ì„±ê³µ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
        const onScanSuccess = (decodedText, decodedResult) => {
            // ì—°ì† ìŠ¤ìº”ì„ ë§‰ê¸° ìœ„í•´ ì ì‹œ ë©ˆì¶¤
            html5QrCode.stop().then((ignore) => {
                checkCoupon(decodedText);
            }).catch((err) => {
                console.error("ìŠ¤ìºë„ˆ ì¤‘ì§€ ì‹¤íŒ¨:", err);
            });
        };

        // APIë¡œ ì¿ í° ê²€ì¦ì„ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜ (ìƒì„¸ ì˜¤ë¥˜ í‘œì‹œ ê¸°ëŠ¥ í¬í•¨)
        async function checkCoupon(code) {
            const display = document.getElementById('result-display');
            display.className = 'warning';
            display.innerText = `ê²€ì¦ ì¤‘... (${code})`;

            try {
                // Apps Script API í˜¸ì¶œ
                const response = await fetch(`${API_URL}?code=${code}`);
                
                // 1. HTTP ìƒíƒœ ì½”ë“œ í™•ì¸
                if (!response.ok) {
                    throw new Error(`HTTP ì ‘ì† ì˜¤ë¥˜! ìƒíƒœ ì½”ë“œ: ${response.status}`);
                }

                // 2. í…ìŠ¤íŠ¸ë¡œ ë¨¼ì € ë°›ì•„ì„œ í™•ì¸
                const textData = await response.text();
                
                // 3. HTML ì—ëŸ¬ í˜ì´ì§€ì¸ì§€ í™•ì¸ (êµ¬ê¸€ ë¡œê·¸ì¸ í˜ì´ì§€ ë“±)
                if (textData.includes("<!DOCTYPE html>") || textData.includes("<html")) {
                    throw new Error("ì„œë²„ê°€ HTMLì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. Apps Script ê¶Œí•œ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
                }

                // 4. JSON íŒŒì‹± ì‹œë„
                let data;
                try {
                    data = JSON.parse(textData);
                } catch (e) {
                    throw new Error(`ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨. ë°›ì€ ë‚´ìš©: ${textData.substring(0, 100)}...`);
                }

                // 5. ê²°ê³¼ í‘œì‹œ
                if (data.valid) {
                    display.className = 'valid';
                    display.innerText = data.message;
                } else {
                    display.className = 'invalid';
                    display.innerText = data.message;
                }

            } catch (error) {
                // ğŸš¨ í™”ë©´ì— ì§„ì§œ ì˜¤ë¥˜ ë‚´ìš©ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
                console.error("API í˜¸ì¶œ ì‹¤íŒ¨:", error);
                display.className = 'invalid';
                display.innerText = `ğŸ›‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
            }

            // 3ì´ˆ í›„ ìŠ¤ìºë„ˆ ì¬ì‹œì‘
            setTimeout(() => {
                startScanner();
            }, 3000);
        }

        // ìŠ¤ìºë„ˆ ì‹œì‘ í•¨ìˆ˜
        const startScanner = () => {
             const display = document.getElementById('result-display');
             display.innerText = "QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”.";
             display.className = 'warning';

            // ì¹´ë©”ë¼ ì„¤ì • (í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ )
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0 
            };
            
            // ì¹´ë©”ë¼ ì‹œì‘
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (err) => {
                // ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ í‘œì‹œ (ê¶Œí•œ ê±°ë¶€ ë“±)
                // display.innerText = `ì¹´ë©”ë¼ ì˜¤ë¥˜: ${err}`;
            });
        };

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
        window.addEventListener('load', startScanner);
    </script>

</body>
</html>






