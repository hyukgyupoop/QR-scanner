<!DOCTYPE html>
<html>
<head>
    <title>QR ì½”ë“œ ì‹¤ì‹œê°„ ê²€ì¦ê¸°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; text-align: center; margin: 0; }
        #reader { width: 100%; max-width: 400px; margin: 20px auto; }
        #result-display { padding: 20px; color: white; font-size: 1.2em; font-weight: bold; min-height: 50px; }
        .valid { background-color: #4CAF50; } /* ë…¹ìƒ‰ */
        .invalid { background-color: #F44336; } /* ë¹¨ê°„ìƒ‰ */
        .warning { background-color: #FF9800; } /* ì£¼í™©ìƒ‰ */
    </style>
</head>
<body>

    <h2>ì¿ í° ì½”ë“œ ìŠ¤ìºë„ˆ</h2>
    <p>QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ ì¤‘ì•™ì— ë§ì¶°ì£¼ì„¸ìš”.</p>

    <div id="reader"></div>

    <div id="result-display">
        ê²°ê³¼ ëŒ€ê¸° ì¤‘...
    </div>

   <script>
        // [ì¤‘ìš”] ë°°í¬ëœ Apps Script ì›¹ ì•± URL (ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”)
        const API_URL = "https://script.google.com/macros/s/AKfycbxexz3AxZ15SXDH5YBXlupScgXbq2wWf4FCKoXmEe6VNz4ioI_mX_-XTEBzoTr7engq/exec"; 

        const html5QrCode = new Html5Qrcode("reader");

        // ìŠ¤ìº” ì„±ê³µ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
        const onScanSuccess = (decodedText, decodedResult) => {
            html5QrCode.stop().then((ignore) => {
                checkCoupon(decodedText);
            }).catch((err) => {
                console.error("ìŠ¤ìºë„ˆ ì¤‘ì§€ ì‹¤íŒ¨:", err);
            });
        };

        // APIë¡œ ì¿ í° ê²€ì¦ì„ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜ (ë””ë²„ê¹… ê°•í™”íŒ)
        async function checkCoupon(code) {
            const display = document.getElementById('result-display');
            display.className = 'warning';
            display.innerText = `ê²€ì¦ ì¤‘... (${code})`;

            try {
                // Apps Script API í˜¸ì¶œ
                const response = await fetch(`${API_URL}?code=${code}`);
                
                // 1. HTTP ìƒíƒœ ì½”ë“œ í™•ì¸ (200 OKê°€ ì•„ë‹ˆë©´ ì˜¤ë¥˜)
                if (!response.ok) {
                    throw new Error(`HTTP ì ‘ì† ì˜¤ë¥˜! ìƒíƒœ ì½”ë“œ: ${response.status}`);
                }

                // 2. í…ìŠ¤íŠ¸ë¡œ ë¨¼ì € ë°›ì•„ì„œ í™•ì¸ (JSONì´ ì•„ë‹ ê²½ìš°ë¥¼ ëŒ€ë¹„)
                const textData = await response.text();
                
                // 3. í…ìŠ¤íŠ¸ ë‚´ìš©ì´ HTML(êµ¬ê¸€ ì—ëŸ¬ í˜ì´ì§€)ì¸ì§€ í™•ì¸
                if (textData.includes("<!DOCTYPE html>") || textData.includes("<html")) {
                    throw new Error("êµ¬ê¸€ ì„œë²„ ì˜¤ë¥˜ ë°˜í™˜ (HTML): ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œì´ë‚˜ ì£¼ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                }

                // 4. JSON íŒŒì‹± ì‹œë„
                let data;
                try {
                    data = JSON.parse(textData);
                } catch (e) {
                    throw new Error(`ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨. ë°›ì€ ë‚´ìš©: ${textData.substring(0, 50)}...`);
                }

                // 5. ê²°ê³¼ í‘œì‹œ
                if (data.valid) {
                    display.className = 'valid';
                    display.innerText = data.message;
                } else {
                    display.className = 'invalid';
                    display.innerText = data.message;
                }

            } catch (error) {
                // ğŸš¨ ì—¬ê¸°ê°€ í•µì‹¬ì…ë‹ˆë‹¤! ì§„ì§œ ì˜¤ë¥˜ ë‚´ìš©ì„ í™”ë©´ì— ì¶œë ¥í•©ë‹ˆë‹¤.
                console.error("API í˜¸ì¶œ ì‹¤íŒ¨:", error);
                display.className = 'invalid';
                // ì‚¬ìš©ìì—ê²Œ ì§„ì§œ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
                display.innerText = `ğŸ›‘ ìƒì„¸ ì˜¤ë¥˜: ${error.message}`;
            }

            // 5ì´ˆ í›„ ìŠ¤ìºë„ˆ ì¬ì‹œì‘
            setTimeout(() => {
                startScanner();
            }, 5000);
        }

        // ìŠ¤ìºë„ˆ ì‹œì‘ í•¨ìˆ˜
        const startScanner = () => {
             document.getElementById('result-display').innerText = "QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”.";
             document.getElementById('result-display').className = 'warning';

            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 }, 
                disableFlip: false 
            };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (err) => {
                // console.error("ìŠ¤ìº” ì˜¤ë¥˜:", err);
            });
        };

        window.addEventListener('load', startScanner);


        // APIë¡œ ì¿ í° ê²€ì¦ì„ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜
        async function checkCoupon(code) {
            const display = document.getElementById('result-display');
            display.className = 'warning';
            display.innerText = `ê²€ì¦ ì¤‘... (${code})`;

            try {
                // Apps Script API í˜¸ì¶œ (GET ìš”ì²­ ì‚¬ìš©)
                const response = await fetch(`${API_URL}?code=${code}`);
                const data = await response.json();

                if (data.valid) {
                    display.className = 'valid';
                    display.innerText = data.message;
                } else {
                    display.className = 'invalid';
                    display.innerText = data.message;
                }
            } catch (error) {
                console.error("API í˜¸ì¶œ ì‹¤íŒ¨:", error);
                display.className = 'invalid';
                display.innerText = "í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.";
            }

            // 3ì´ˆ í›„ ìŠ¤ìºë„ˆ ì¬ì‹œì‘
            setTimeout(() => {
                startScanner();
            }, 3000);
        }

        // ìŠ¤ìºë„ˆ ì‹œì‘ í•¨ìˆ˜
        const startScanner = () => {
             document.getElementById('result-display').innerText = "QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”.";
             document.getElementById('result-display').className = 'warning';

            // ì¹´ë©”ë¼ ì„¤ì • (í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ )
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 }, 
                disableFlip: false 
            };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (err) => {
                // console.error("ìŠ¤ìº” ì˜¤ë¥˜:", err);
            });
        };

        // í˜ì´ì§€ ë¡œë“œ í›„ ìŠ¤ìºë„ˆ ì‹œì‘
        window.addEventListener('load', startScanner);
    </script>

</body>

</html>




