<!DOCTYPE html>
<html>
<head>
    <title>QR ì½”ë“œ ìŠ¤ë§ˆíŠ¸ ìŠ¤ìºë„ˆ</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; text-align: center; margin: 0; padding: 0; background-color: #222; color: #fff; }
        h2 { margin-top: 20px; color: #fff; }
        #reader { width: 100%; max-width: 500px; margin: 20px auto; border: 5px solid #444; border-radius: 10px; }
        #result-display { 
            padding: 20px; margin: 15px; font-size: 1.2em; font-weight: bold; 
            min-height: 60px; border-radius: 10px; word-break: break-all; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .ready { background-color: #444; color: #ccc; }
        .scanning { background-color: #FF9800; color: white; } /* ì£¼í™©ìƒ‰ */
        .valid { background-color: #4CAF50; color: white; font-size: 1.4em; } /* ë…¹ìƒ‰ */
        .invalid { background-color: #F44336; color: white; } /* ë¹¨ê°„ìƒ‰ */
    </style>
</head>
<body>

    <h2>ğŸ« ì¿ í° í™•ì¸í•˜ê¸°</h2>
    
    <div id="reader"></div>

    <div id="result-display" class="ready">
        ì¹´ë©”ë¼ ë¡œë”© ì¤‘...
    </div>

    <script>
        // ğŸš¨ [ì¤‘ìš”] 'ìƒˆ ë°°í¬'ë¡œ ë°›ì€ Apps Script URLì„ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš”!
        const API_URL = "https://script.google.com/macros/s/AKfycbzT0J67q0lz2vsOFgjFdk6G1jfi-7odomKiRL7d5jvOPnu_HseY40ZC021O7aMViNdr/exec"; 

        const html5QrCode = new Html5Qrcode("reader");
        
        // ì†Œë¦¬ ì¬ìƒì„ ìœ„í•œ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // ğŸµ ë¹„í”„ìŒ ì¬ìƒ í•¨ìˆ˜ (type: 'success' or 'error')
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            if (type === 'success') {
                // ì„±ê³µ: ë”©~ë™~ (ë†’ì€ìŒ)
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // A5
                oscillator.frequency.exponentialRampToValueAtTime(1760, audioCtx.currentTime + 0.1); // A6
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
            } else {
                // ì‹¤íŒ¨: ì‚--- (ë‚®ì€ ê²½ê³ ìŒ)
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.5);
            }
        }

        // ğŸ“³ ì§„ë™ í•¨ìˆ˜
        function triggerVibration(type) {
            if (navigator.vibrate) {
                if (type === 'success') {
                    navigator.vibrate(100); // ì§§ê²Œ í•œ ë²ˆ
                } else {
                    navigator.vibrate([300, 100, 300]); // ê¸¸ê²Œ ë‘ ë²ˆ (ì§•- ì§•-)
                }
            }
        }

        const onScanSuccess = (decodedText, decodedResult) => {
            html5QrCode.stop().then(() => {
                checkCoupon(decodedText);
            }).catch(console.error);
        };

        async function checkCoupon(code) {
            const display = document.getElementById('result-display');
            display.className = 'scanning';
            display.innerText = `ğŸ” í™•ì¸ ì¤‘... (${code})`;

            try {
                const response = await fetch(`${API_URL}?code=${code}`);
                if (!response.ok) throw new Error(`HTTP ì˜¤ë¥˜: ${response.status}`);
                
                const textData = await response.text();
                if (textData.includes("<html")) throw new Error("ë°°í¬ ê¶Œí•œ ì˜¤ë¥˜ (HTML ë°˜í™˜ë¨)");

                let data = JSON.parse(textData);

                if (data.valid) {
                    // âœ… ì„±ê³µ ì‹œ
                    display.className = 'valid';
                    display.innerText = data.message;
                    playSound('success');       // ì†Œë¦¬ (ë”©ë™)
                    triggerVibration('success');// ì§„ë™ (ì§§ê²Œ)
                } else {
                    // âŒ ì‹¤íŒ¨/ì¤‘ë³µ ì‹œ
                    display.className = 'invalid';
                    display.innerText = data.message;
                    playSound('error');         // ì†Œë¦¬ (ì‚-)
                    triggerVibration('error');  // ì§„ë™ (ê¸¸ê²Œ)
                }

            } catch (error) {
                console.error(error);
                display.className = 'invalid';
                display.innerText = `ğŸ›‘ ì˜¤ë¥˜: ${error.message}`;
                playSound('error');
                triggerVibration('error');
            }

            // 5ì´ˆ í›„ ì¬ì‹œì‘ (ìš”ì²­í•˜ì‹  ëŒ€ë¡œ ìœ ì§€)
            setTimeout(startScanner, 5000);
        }

        const startScanner = () => {
             const display = document.getElementById('result-display');
             display.innerText = "QR ì½”ë“œë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”";
             display.className = 'ready';

            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess);
        };

        window.addEventListener('load', startScanner);
        
        // [ì°¸ê³ ] ë¸Œë¼ìš°ì € ì •ì±…ìƒ ì‚¬ìš©ìê°€ í™”ë©´ì„ í„°ì¹˜í•´ì•¼ ì†Œë¦¬ê°€ ë‚  ìˆ˜ ìˆìŒ
        document.body.addEventListener('click', () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
        });
    </script>

</body>
</html>
