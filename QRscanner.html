<!DOCTYPE html>
<html>
<head>
    <title>QR 코드 실시간 검증기</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; text-align: center; margin: 0; }
        #reader { width: 100%; max-width: 400px; margin: 20px auto; }
        #result-display { padding: 20px; color: white; font-size: 1.2em; font-weight: bold; min-height: 50px; }
        .valid { background-color: #4CAF50; } /* 녹색 */
        .invalid { background-color: #F44336; } /* 빨간색 */
        .warning { background-color: #FF9800; } /* 주황색 */
    </style>
</head>
<body>

    <h2>쿠폰 코드 스캐너</h2>
    <p>QR 코드를 카메라 중앙에 맞춰주세요.</p>

    <div id="reader"></div>

    <div id="result-display">
        결과 대기 중...
    </div>

    <script>
        // [중요] 여기에 2단계에서 복사한 Apps Script 웹 앱 URL을 붙여넣으세요!
        const API_URL = "https://script.google.com/macros/s/AKfycbxexz3AxZ15SXDH5YBxIupScgXbq2wWf4FCKoXmEe6VNz4ioI_mX_-XTEBzoTr7engq/exec"; 

        const html5QrCode = new Html5Qrcode("reader");

        // 스캔 성공 시 실행되는 함수
        const onScanSuccess = (decodedText, decodedResult) => {
            html5QrCode.stop().then((ignore) => {
                checkCoupon(decodedText);
            }).catch((err) => {
                console.error("스캐너 중지 실패:", err);
            });
        };

        // API로 쿠폰 검증을 요청하는 함수
        async function checkCoupon(code) {
            const display = document.getElementById('result-display');
            display.className = 'warning';
            display.innerText = `검증 중... (${code})`;

            try {
                // Apps Script API 호출 (GET 요청 사용)
                const response = await fetch(`${API_URL}?code=${code}`);
                const data = await response.json();

                if (data.valid) {
                    display.className = 'valid';
                    display.innerText = data.message;
                } else {
                    display.className = 'invalid';
                    display.innerText = data.message;
                }
            } catch (error) {
                console.error("API 호출 실패:", error);
                display.className = 'invalid';
                display.innerText = "통신 오류가 발생했습니다. 네트워크 상태를 확인하세요.";
            }

            // 3초 후 스캐너 재시작
            setTimeout(() => {
                startScanner();
            }, 3000);
        }

        // 스캐너 시작 함수
        const startScanner = () => {
             document.getElementById('result-display').innerText = "QR 코드를 스캔하세요.";
             document.getElementById('result-display').className = 'warning';

            // 카메라 설정 (후면 카메라 우선)
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 }, 
                disableFlip: false 
            };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (err) => {
                // console.error("스캔 오류:", err);
            });
        };

        // 페이지 로드 후 스캐너 시작
        window.addEventListener('load', startScanner);
    </script>

</body>

</html>

